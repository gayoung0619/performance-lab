# 가상 스크롤 만들기
### 설명
리스트 데이터의 개수가 일정개수를 초과하는 경우 모든 리스트를 렌더링하게 되면 성능적으로 문제가 발생하게 된다. 그래서 뷰포트영역에 보이는 리스트만 렌더링을 하고, 실제 데이터가 존재하는 만큼의 스크롤을 표현하여 성능 개선을 하는 기술이 가상 스크롤이다.

<br />

## 코드 작성

### 스크롤 컴포넌트
스크롤 컴포넌트는 전체 리스트 개수, 아이템의 높이, 컨테이너의 높이를 통해 계산 된 스크롤의 높이를 전달받는다. 사용자가 휠을 통해 이동하게 되면, 이동 수치와 휠의 횟수를 계산해서 스크롤의 위치를 계산하게 된다. 이 두가지 정보를 토대로 렌더링을 하게 된다.

<br />

### 리스트 컴포넌트
리스트 컴포넌트는 렌더링할 데이터와 사용자가 스크롤했을 때 데이터가 위 또는 아래로 움직이기 위한 좌표를 전달받는다. 뷰포트영역의 위아래로 추가적인 리스트를 렌더링하여 실제로 많은 데이터가 보이는 것처럼 표현한다.

<br />

처음 구상할때는 전달받은 리스트의 가장 아래로 스크롤이 이동하게 되면 새로운 그때 재계산을 해서 새로운 리스트 배열을 전달받으려고 했다. 하지만 가상스크롤은 브라우저의 스크롤을 사용하는 것이 아니기 때문에 top의 값을 직접 변경해서 이동시켜주어야 하기 때문에, 스크롤 시마다 리렌더링을 해줘야 한다. 그래서 스크롤시마다 모든 계산 과정 및 리렌더링을 하고 있다. 이는 추후 리팩토링을 할 여지는 많을 것 같다.

<br />

## 알게 된점
### 1. 자식의 자식의 컴포넌트의 ref
이번에 리스트의 아이템의 높이값이 필요해서 컨테이너의 자식인 리스트의 자식인 아이템에 ref를 전달해야할 경우가 생겼다. 기존에 자식 컴포넌트에 ref를 할당하기 위해 forwardRef를 사용했었는데, 자식의 자식에도 사용할 수 있다는 것을 알게 되었다.

<br />
### 2. cleanup 시점에 ref.current 사용의 문제점
useEffect를 사용할 때 종종 클린업을 사용하게 된다. 이때 클린업 함수 내에서 ref.current를 사용하게 되면 예상치 않은 결과를 만들수도 있다. 왜냐하면 클린업은 컴포넌트가 언마운트되거나 useEffect가 다시 실행되기 전에 호출되는데, ref의 경우 값이 변경되어도 리렌더링이 발생하지 않는다. 이 때문에 useEffect의 호출을 유발하지 않게 된다. 즉, 클린업 함수가 호출되는 시점의 ref와 함수가 정의될때의 ref의 값이 다를 수 있다는 것이다. 왜냐하면 클로저를 활용하고 있기 때문에...

<br />

## 개선 여지
### 1. 배열 계산을 useMemo로 사용해보자.
사용자가 스크롤할때마다 현재 위치를 재계산해서 리스트 데이터배열에서 화면에 렌더링할 배열을 추출하고 있다. 단순 필터작업이기 때문에 시간적으로 오래걸리지 않을 수 있으나, 스크롤은 빠른시간에 여러번 발생할 수 있고 데이터의 개수가 많은 경우에 버벅거리는 문제가 발생할 여지는 존재한다. 추가로 매번 새로운 배열을 만들기 때문에 아이템들이 리렌더링 될 것 같다(확인 필요 - key는 동일하기 때문에 될지 안될지 모르겠다).

그래서 매번 새로운 배열을 만들지 않고, 스크롤이 뷰포트 가장 아래에 왔을 때만 배열을 재계산하도록 수정한다. 이를 위하 useMemo를 활용한다. 이를 통해 top의 값을 변경되겠지만, 배열은 변화가 없기 때문에 아이템이 리렌더링 되는 것을 일부 방지할 수 있지 않을까 생각한다.

<br />

### 2. Observer API 사용해서 마지막 위치에 스크롤 도달여부 확인
1번 개선 사항을 수정한 후에 마지막 아이템으로 이동했는지 체크 여부를 매번 스크롤시마다 하는 것이 아닌 Observer API에 위임하도록 한다. 이를 통해서 계산작업에 대한 비용을 줄일 수 있지 않을까 생각해본다. 하지만 Observer API를 사용하는 이유가, 이전에는 스크롤 위치를 계산하기 위해 스크롤 이벤트 리스너를 등록해놓고 스크롤시마다 리스너가 호출되는 것을 방지하기 위해서이다. 하지만 가상 스크롤은 스크롤 이벤트 리스너가 필수적이기 때문에 Observer API가 큰 효과를 발휘할지는 의문이기는 하다.

<br />

## 정리
오랜만에 리액트로 게시판이나 정적 페이지이외의 작업을 해볼 수 있어서 재밌는 시간이었다. 스크롤의 위치를 계산하는 등의 계산작업이 많아 머리가 많이 아프긴 했으나 결과를 보니 뿌듯하고 만족스럽다. 그리고 전에 잘 활용하지 않았던 리액트 기술들을 활용해볼 수 있어 리액트에 대한 이해도가 조금 상승한 기분이다.